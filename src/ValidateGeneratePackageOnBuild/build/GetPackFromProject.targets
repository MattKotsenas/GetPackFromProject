<Project>

  <Target Name="AddProjectPackagesAsOutput" BeforeTargets="Build">
    <ItemGroup>
      <_ProjectsToCopy Include="%(ProjectReference.Identity)" Condition="'%(ProjectReference.AddPackageAsOutput)'  == 'true'" />
    </ItemGroup>

    <Message Text="Projects to copy @(_ProjectsToCopy)" Importance="Low" />

    <ValidateGeneratePackageOnBuild Condition="'%(_ProjectsToCopy.Identity)' != ''" ProjectFile="%(_ProjectsToCopy.Identity)" AttachDebugger="$(ValidateGeneratePackageOnBuildShouldDebug)" />

    <!-- TODO: Ideally we could rely on a public API and not a private target -->
    <MSBuild Projects="%(_ProjectsToCopy.Identity)" Targets="_GetOutputItemsFromPack">
      <Output TaskParameter="TargetOutputs" ItemName="_DependentPackageOutputs" />
    </MSBuild>

    <Message Text="Dependent TargetOutputs is '%(_DependentPackageOutputs.Identity)'" Importance="Low" />

    <ItemGroup Condition="'@(_ProjectsToCopy)' != ''">
      <!-- Update the ProjectReference with its outputs to make finding them easier for users -->
      <ProjectReference Update="%(ProjectReference.Identity)">
        <PackageOutputs>@(_DependentPackageOutputs)</PackageOutputs>
      </ProjectReference>

      <!-- Add the .nupkg(s) as Content so users can copy them to output / embed them, etc. -->
      <Content Include="%(_DependentPackageOutputs.Identity)" Condition="'$([System.IO.Path]::GetExtension(%(_DependentPackageOutputs.Identity)))' == '.nupkg'" CopyToOutputDirectory="PreserveNewest">
        <IsPackageFromProjectReference>true</IsPackageFromProjectReference>
      </Content>
    </ItemGroup>

    <!-- Clear temp items used for batching -->
    <ItemGroup>
      <_DependentPackageOutputs Remove="*" />
    </ItemGroup>
  </Target>

</Project>
